# 🏗️ System Architecture Diagrams

## Complete Self-Hosted RAG Architecture

### High-Level Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         USER BROWSER                            │
│                     http://localhost:3000                       │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (React + TailwindCSS)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Login      │  │  Dashboard   │  │ Connections  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐                           │
│  │ ChatInterface│  │   Settings   │                           │
│  └──────────────┘  └──────────────┘                           │
│                                                                 │
│  Port: 3000                                                     │
└────────────────────────────┬────────────────────────────────────┘
                             │ REST API
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND (FastAPI)                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    API LAYER                             │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │  │
│  │  │  auth.py │  │ query.py │  │ conn.py  │  │ sett.py │ │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                             │                                   │
│  ┌──────────────────────────┴────────────────────────────────┐ │
│  │                   RAG SERVICE LAYER                       │ │
│  │  ┌─────────────────────┐  ┌─────────────────────┐        │ │
│  │  │  RAGService         │  │ LocalRAGService     │        │ │
│  │  │  (OpenAI)           │  │ (Self-Hosted)       │        │ │
│  │  │  USE_LOCAL=false    │  │ USE_LOCAL=true ✓    │        │ │
│  │  └─────────────────────┘  └─────────────────────┘        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                             │                                   │
│  Port: 8000                 │                                   │
└─────────────────────────────┼───────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌──────────────────┐   ┌──────────────────┐
│   EMBEDDING   │   │   OLLAMA (LLM)   │   │   POSTGRESQL     │
│   SERVICE     │   │                  │   │   + pgvector     │
│               │   │  Models:         │   │                  │
│ sentence-     │   │  - llama3.2      │   │  Tables:         │
│ transformers  │   │  - phi3          │   │  - users         │
│               │   │  - tinyllama     │   │  - connections   │
│ Model:        │   │                  │   │  - vectors       │
│ all-MiniLM-   │   │  Port: 11434     │   │  - history       │
│ L6-v2         │   │                  │   │                  │
│               │   │                  │   │  Port: 5432      │
│ Port: 8001    │   │                  │   │                  │
└───────────────┘   └──────────────────┘   └──────────────────┘
        │                     │                     │
        └─────────────────────┴─────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  USER DATABASES  │
                    │                  │
                    │  - PostgreSQL    │
                    │  - MongoDB       │
                    │  - (Future: More)│
                    └──────────────────┘
```

---

## Data Flow Diagrams

### 1. Connection Creation Flow

```
┌──────────┐
│   USER   │
└────┬─────┘
     │ 1. Provide connection string
     ▼
┌─────────────────┐
│    FRONTEND     │
└────┬────────────┘
     │ 2. POST /api/connections
     ▼
┌─────────────────────────────────────────┐
│           BACKEND API                   │
│  ┌─────────────────────────────────┐   │
│  │  connections.py                 │   │
│  │  - Validate input               │   │
│  │  - Test connection              │   │
│  └────┬────────────────────────────┘   │
└───────┼─────────────────────────────────┘
        │ 3. Connect to user DB
        ▼
┌─────────────────┐
│  USER DATABASE  │
│  - Extract      │
│    schema       │
│  - Sample data  │
└────┬────────────┘
     │ 4. Schema + samples
     ▼
┌─────────────────────────────────────────┐
│      RAG SERVICE (Local)                │
│  ┌─────────────────────────────────┐   │
│  │  1. Convert to text chunks      │   │
│  │  2. Generate embeddings         │   │
│  │  3. Store in pgvector           │   │
│  └─────────────────────────────────┘   │
└────┬────────────────────────────────────┘
     │ 5. Call embedding service
     ▼
┌─────────────────┐
│   EMBEDDING     │
│   SERVICE       │
│  - Generate     │
│    vectors      │
└────┬────────────┘
     │ 6. Return embeddings
     ▼
┌─────────────────┐
│   POSTGRESQL    │
│   + pgvector    │
│  - Store        │
│    vectors      │
└────┬────────────┘
     │ 7. Success
     ▼
┌──────────┐
│   USER   │
│ "Ready!" │
└──────────┘
```

---

### 2. Query Execution Flow

```
┌──────────┐
│   USER   │
└────┬─────┘
     │ 1. "Show me all users"
     ▼
┌─────────────────┐
│    FRONTEND     │
└────┬────────────┘
     │ 2. POST /api/query
     ▼
┌─────────────────────────────────────────┐
│           BACKEND API                   │
│  ┌─────────────────────────────────┐   │
│  │  query.py                       │   │
│  │  - Get connection               │   │
│  │  - Initialize RAG service       │   │
│  └────┬────────────────────────────┘   │
└───────┼─────────────────────────────────┘
        │ 3. Query with RAG
        ▼
┌─────────────────────────────────────────┐
│      RAG SERVICE (Local)                │
│  ┌─────────────────────────────────┐   │
│  │  STEP 1: Embed Query            │   │
│  └────┬────────────────────────────┘   │
└───────┼─────────────────────────────────┘
        │ 4. Embed user query
        ▼
┌─────────────────┐
│   EMBEDDING     │
│   SERVICE       │
│  - Convert      │
│    query to     │
│    vector       │
└────┬────────────┘
     │ 5. Query vector
     ▼
┌─────────────────────────────────────────┐
│      RAG SERVICE (Local)                │
│  ┌─────────────────────────────────┐   │
│  │  STEP 2: Vector Search          │   │
│  └────┬────────────────────────────┘   │
└───────┼─────────────────────────────────┘
        │ 6. Similarity search
        ▼
┌─────────────────┐
│   POSTGRESQL    │
│   + pgvector    │
│  - Find top-k   │
│    similar      │
│    vectors      │
└────┬────────────┘
     │ 7. Relevant context
     ▼
┌─────────────────────────────────────────┐
│      RAG SERVICE (Local)                │
│  ┌─────────────────────────────────┐   │
│  │  STEP 3: Generate Response      │   │
│  │  - Construct prompt             │   │
│  │  - Add context                  │   │
│  └────┬────────────────────────────┘   │
└───────┼─────────────────────────────────┘
        │ 8. Generate answer
        ▼
┌─────────────────┐
│   OLLAMA LLM    │
│  - Process      │
│    prompt       │
│  - Generate     │
│    response     │
└────┬────────────┘
     │ 9. Natural language answer
     ▼
┌─────────────────────────────────────────┐
│           BACKEND API                   │
│  ┌─────────────────────────────────┐   │
│  │  - Save to history              │   │
│  │  - Return response              │   │
│  └────┬────────────────────────────┘   │
└───────┼─────────────────────────────────┘
        │ 10. JSON response
        ▼
┌─────────────────┐
│    FRONTEND     │
│  - Display      │
│    answer       │
└────┬────────────┘
     │ 11. Show answer
     ▼
┌──────────┐
│   USER   │
│ "Got it!"│
└──────────┘
```

---

## Component Interaction Matrix

```
┌──────────────┬──────────┬──────────┬──────────┬──────────┬──────────┐
│              │ Frontend │ Backend  │ Embed    │ Ollama   │ Postgres │
├──────────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Frontend     │    -     │   REST   │    -     │    -     │    -     │
├──────────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Backend      │   JSON   │    -     │   HTTP   │   HTTP   │   SQL    │
├──────────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Embed Svc    │    -     │   JSON   │    -     │    -     │    -     │
├──────────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Ollama       │    -     │   JSON   │    -     │    -     │    -     │
├──────────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Postgres     │    -     │  Result  │    -     │    -     │    -     │
└──────────────┴──────────┴──────────┴──────────┴──────────┴──────────┘
```

---

## Docker Network Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Network (bridge)                  │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  frontend    │  │   backend    │  │  embedding   │    │
│  │              │  │              │  │   -service   │    │
│  │  Port: 3000  │  │  Port: 8000  │  │  Port: 8001  │    │
│  │  Exposed: ✓  │  │  Exposed: ✓  │  │  Exposed: ✓  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐                       │
│  │   ollama     │  │   postgres   │                       │
│  │              │  │              │                       │
│  │  Port: 11434 │  │  Port: 5432  │                       │
│  │  Exposed: ✓  │  │  Exposed: ✓  │                       │
│  └──────────────┘  └──────────────┘                       │
│                                                             │
│  Volumes:                                                   │
│  - postgres_data (persistent)                               │
│  - ollama_data (persistent)                                 │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
         └────────────────────┴────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │   HOST MACHINE    │
                    │   localhost       │
                    └───────────────────┘
```

---

## Deployment Architecture (AWS)

```
┌─────────────────────────────────────────────────────────────┐
│                      AWS CLOUD                              │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              EC2 Instance (t2.micro)                 │  │
│  │              Ubuntu 22.04 LTS                        │  │
│  │                                                      │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │         Docker Compose Stack                   │ │  │
│  │  │                                                │ │  │
│  │  │  Frontend → Backend → Embedding → Ollama      │ │  │
│  │  │                  ↓                             │ │  │
│  │  │              PostgreSQL                        │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │         Nginx (Reverse Proxy)                  │ │  │
│  │  │  - Port 80/443                                 │ │  │
│  │  │  - SSL/TLS (Let's Encrypt)                     │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  │  Security Group:                                     │  │
│  │  - SSH (22) - Your IP only                          │  │
│  │  - HTTP (80) - 0.0.0.0/0                            │  │
│  │  - HTTPS (443) - 0.0.0.0/0                          │  │
│  └──────────────────────────────────────────────────────┘  │
│                           │                                 │
│  ┌────────────────────────┴──────────────────────────────┐ │
│  │              EBS Volume (30GB)                        │ │
│  │  - OS + Docker images                                 │ │
│  │  - Ollama models                                      │ │
│  │  - PostgreSQL data                                    │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              ▼
                    ┌──────────────────┐
                    │      USERS       │
                    │   (Internet)     │
                    └──────────────────┘
```

---

## Scaling Architecture (Future)

```
┌─────────────────────────────────────────────────────────────┐
│                      AWS CLOUD                              │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │     Application Load Balancer (ALB)                  │  │
│  │     - HTTPS termination                              │  │
│  │     - Health checks                                  │  │
│  └────────────┬─────────────────────┬───────────────────┘  │
│               │                     │                       │
│  ┌────────────▼──────────┐  ┌──────▼────────────────────┐ │
│  │   EC2 Instance 1      │  │   EC2 Instance 2          │ │
│  │   - Frontend          │  │   - Frontend              │ │
│  │   - Backend           │  │   - Backend               │ │
│  │   - Embedding Service │  │   - Embedding Service     │ │
│  │   - Ollama            │  │   - Ollama                │ │
│  └───────────────────────┘  └───────────────────────────┘ │
│               │                     │                       │
│               └─────────┬───────────┘                       │
│                         │                                   │
│  ┌──────────────────────▼──────────────────────────────┐  │
│  │         RDS PostgreSQL + pgvector                    │  │
│  │         - Multi-AZ                                   │  │
│  │         - Automated backups                          │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         ElastiCache (Redis)                          │  │
│  │         - Response caching                           │  │
│  │         - Session storage                            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Technology Stack Layers

```
┌─────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                       │
│  React 18 + TailwindCSS + Axios                            │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                    APPLICATION LAYER                        │
│  FastAPI + Pydantic + Python 3.11                          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                    BUSINESS LOGIC LAYER                     │
│  RAG Service + Database Connectors + Auth                  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                    AI/ML LAYER                              │
│  Embeddings (sentence-transformers) + LLM (Ollama)         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                    DATA LAYER                               │
│  PostgreSQL + pgvector + SQLAlchemy                        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                    INFRASTRUCTURE LAYER                     │
│  Docker + Docker Compose + AWS EC2                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    SECURITY LAYERS                          │
│                                                             │
│  Layer 1: Network Security                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  - AWS Security Groups                               │  │
│  │  - Firewall (ufw)                                    │  │
│  │  - HTTPS/TLS encryption                              │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  Layer 2: Application Security                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  - JWT authentication                                │  │
│  │  - Password hashing (bcrypt)                         │  │
│  │  - Input validation (Pydantic)                       │  │
│  │  - CORS configuration                                │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  Layer 3: Data Security                                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  - Connection string encryption (TODO)               │  │
│  │  - Database access control                           │  │
│  │  - User data isolation                               │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  Layer 4: Infrastructure Security                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  - SSH key authentication                            │  │
│  │  - Regular security updates                          │  │
│  │  - Docker container isolation                        │  │
│  │  - Environment variable secrets                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Monitoring & Observability

```
┌─────────────────────────────────────────────────────────────┐
│                    MONITORING STACK                         │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Application Logs                                    │  │
│  │  - Docker logs                                       │  │
│  │  - FastAPI logs                                      │  │
│  │  - Ollama logs                                       │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│  ┌──────────────────────▼───────────────────────────────┐  │
│  │  Health Checks                                       │  │
│  │  - /health endpoints                                 │  │
│  │  - Docker healthchecks                               │  │
│  │  - Service availability                              │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│  ┌──────────────────────▼───────────────────────────────┐  │
│  │  Metrics (Future)                                    │  │
│  │  - Response times                                    │  │
│  │  - Query volume                                      │  │
│  │  - Resource usage                                    │  │
│  │  - Error rates                                       │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│  ┌──────────────────────▼───────────────────────────────┐  │
│  │  Alerting (Future)                                   │  │
│  │  - Service downtime                                  │  │
│  │  - High error rates                                  │  │
│  │  - Resource exhaustion                               │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Summary

This architecture provides:

✅ **Complete self-hosting** - No external dependencies
✅ **Scalability** - Start small, scale as needed
✅ **Security** - Multiple layers of protection
✅ **Observability** - Comprehensive logging and monitoring
✅ **Cost-effective** - AWS Free Tier compatible
✅ **Production-ready** - Battle-tested components

**You're ready to deploy!** 🚀

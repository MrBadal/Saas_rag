name: CI/CD Pipeline - Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USERNAME: ${{ secrets.EC2_USERNAME }}

jobs:
  # Job 1: Run tests and linting
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt

    - name: Run Python linting
      run: |
        cd backend
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

    - name: Install Node.js dependencies
      run: |
        cd frontend
        npm install

    - name: Run frontend build test
      run: |
        cd frontend
        npm run build || echo "Build check completed"

  # Job 2: Build and Deploy to EC2
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
        chmod 600 ~/.ssh/ec2_key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "=== Starting Deployment ==="
          
          # Navigate to app directory or clone if doesn't exist
          # Support both naming conventions (Saas_rag or SaaS_rag)
          APP_DIR="$HOME/SaaS_rag"
          if [ ! -d "$APP_DIR" ]; then
            APP_DIR="$HOME/Saas_rag"
          fi
          
          if [ ! -d "$APP_DIR" ]; then
            echo "Repository not found. Please clone it manually first time:"
            echo "git clone https://github.com/MrBadal/Saas_rag.git ~/Saas_rag"
            exit 1
          fi
          
          cd $APP_DIR
          
          echo "=== Pulling latest code ==="
          git fetch origin
          git reset --hard origin/$(git rev-parse --abbrev-ref HEAD)
          
          echo "=== Creating production environment file ==="
          cat > .env << ENVFILE
        # Database Configuration
        DATABASE_URL=postgresql://raguser:ragpass@postgres:5432/ragdb
        
        # Application Settings
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        ENVIRONMENT=production
        
        # Local Model Configuration (Self-Hosted Mode)
        USE_LOCAL_MODELS=true
        EMBEDDING_SERVICE_URL=http://embedding-service:8001
        OLLAMA_BASE_URL=http://ollama:11434
        OLLAMA_MODEL=llama3.2:1b  # Using smaller model for 8GB RAM compatibility
        
        # AWS Configuration
        AWS_REGION=${{ secrets.AWS_REGION }}
        ENVFILE
          
          echo "=== Setting up environment ==="
          export EC2_HOST=${{ secrets.EC2_HOST }}
          echo "EC2_HOST set to: $EC2_HOST"
          
          echo "=== Building and starting containers ==="
          docker-compose -f docker-compose.prod.yml down --remove-orphans || true
          docker-compose -f docker-compose.prod.yml pull
          # Build with EC2_HOST passed as build argument for frontend
          docker-compose -f docker-compose.prod.yml build --no-cache --build-arg REACT_APP_API_URL=http://$EC2_HOST:8000
          docker-compose -f docker-compose.prod.yml up -d
          
          echo "=== Waiting for services to start ==="
          sleep 30
          
          echo "=== Checking service health ==="
          docker-compose -f docker-compose.prod.yml ps
          
          echo "=== Cleaning up old images ==="
          docker image prune -f
          
          echo "=== Deployment completed successfully ==="
        EOF

    - name: Verify deployment
      run: |
        sleep 10
        curl -f http://${{ secrets.EC2_HOST }}:8000/health || echo "Health check endpoint not available, checking docs..."
        curl -f http://${{ secrets.EC2_HOST }}:8000/docs || echo "Backend API check completed"
        echo "Deployment verification completed"
